name: Deploy to Scaleway

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    name: Deploy to Scaleway
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      - name: Install Scaleway CLI
        uses: scaleway/action-scw@v0
        with:
          version: v2.45.0
          access-key: ${{ secrets.SCW_ACCESS_KEY }}
          secret-key: ${{ secrets.SCW_SECRET_KEY }}
          default-project-id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          default-organization-id: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
          export-config: true

      - name: Deploy to Scaleway
        env:
          IMAGE_TAG: ${{ steps.version.outputs.version }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          chmod +x scripts/deploy-container.sh
          ./scripts/deploy-container.sh

      - name: Validate deployment
        run: |
          # Get container info
          CONTAINER_INFO=$(scw container container list region=fr-par -o json | jq -r '.[] | select(.name == "miro-mcp-server")')
          CONTAINER_URL=$(echo "$CONTAINER_INFO" | jq -r '.domain_name')
          CONTAINER_STATUS=$(echo "$CONTAINER_INFO" | jq -r '.status')

          echo "Container Status: $CONTAINER_STATUS"
          echo "Container URL: https://$CONTAINER_URL"

          # Wait for container to be ready
          MAX_ATTEMPTS=24
          SLEEP_INTERVAL=5

          for i in $(seq 1 $MAX_ATTEMPTS); do
            CURRENT_STATUS=$(scw container container list region=fr-par -o json | jq -r '.[] | select(.name == "miro-mcp-server") | .status')
            echo "Attempt $i/$MAX_ATTEMPTS - Status: $CURRENT_STATUS"

            if [ "$CURRENT_STATUS" == "ready" ]; then
              echo "✓ Container is ready"
              break
            elif [ "$CURRENT_STATUS" == "error" ]; then
              echo "✗ Container failed to start"
              scw container container get region=fr-par container-id=$(echo "$CONTAINER_INFO" | jq -r '.id') -o json | jq '.error_message'
              exit 1
            fi

            if [ $i -lt $MAX_ATTEMPTS ]; then
              sleep $SLEEP_INTERVAL
            else
              echo "✗ Timeout waiting for container to be ready"
              exit 1
            fi
          done

          # Test health endpoint
          HEALTH_ENDPOINT="https://${CONTAINER_URL}/health"
          echo "Testing health endpoint: $HEALTH_ENDPOINT"

          if curl -f -s "$HEALTH_ENDPOINT" > /dev/null 2>&1; then
            echo "✓ Health check passed"
            curl -s "$HEALTH_ENDPOINT"
          else
            echo "✗ Health check failed"
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          CONTAINER_INFO=$(scw container container list region=fr-par -o json | jq -r '.[] | select(.name == "miro-mcp-server")')
          CONTAINER_URL=$(echo "$CONTAINER_INFO" | jq -r '.domain_name')
          CONTAINER_STATUS=$(echo "$CONTAINER_INFO" | jq -r '.status')

          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Container:** miro-mcp-server" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $CONTAINER_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${CONTAINER_URL}" >> $GITHUB_STEP_SUMMARY
          echo "**Health:** https://${CONTAINER_URL}/health" >> $GITHUB_STEP_SUMMARY
          echo "**OAuth:** https://${CONTAINER_URL}/oauth/authorize" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "**Result:** ✓ Deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Result:** ✗ Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
