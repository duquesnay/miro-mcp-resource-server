name: Deploy to Scaleway

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  PROJECT_NAME: miro-mcp-adr005
  REGION: fr-par

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Scaleway CLI
        uses: scaleway/action-scw@v0
        with:
          version: v2.45.0
          access-key: ${{ secrets.SCW_ACCESS_KEY }}
          secret-key: ${{ secrets.SCW_SECRET_KEY }}
          default-project-id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          default-organization-id: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
          export-config: true

      - name: Get Scaleway Container Registry
        id: registry
        run: |
          CONTAINER_NAMESPACE_ID=$(scw container namespace list region=${{ env.REGION }} -o json | jq -r '.[0].id')
          REGISTRY_NAMESPACE_ID=$(scw container namespace list region=${{ env.REGION }} -o json | jq -r '.[0].registry_namespace_id')
          REGISTRY_ENDPOINT=$(scw registry namespace get ${REGISTRY_NAMESPACE_ID} region=${{ env.REGION }} -o json | jq -r '.endpoint')
          echo "endpoint=$REGISTRY_ENDPOINT" >> $GITHUB_OUTPUT
          echo "namespace_id=$CONTAINER_NAMESPACE_ID" >> $GITHUB_OUTPUT
          echo "Registry: $REGISTRY_ENDPOINT"

      - name: Login to Scaleway Container Registry
        run: |
          scw registry login region=${{ env.REGION }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.PROJECT_NAME }}:latest .
          docker tag ${{ env.PROJECT_NAME }}:latest ${{ steps.registry.outputs.endpoint }}/${{ env.PROJECT_NAME }}:latest
          docker tag ${{ env.PROJECT_NAME }}:latest ${{ steps.registry.outputs.endpoint }}/${{ env.PROJECT_NAME }}:${{ github.sha }}
          docker push ${{ steps.registry.outputs.endpoint }}/${{ env.PROJECT_NAME }}:latest
          docker push ${{ steps.registry.outputs.endpoint }}/${{ env.PROJECT_NAME }}:${{ github.sha }}

      - name: Deploy to Scaleway Containers
        env:
          MIRO_CLIENT_ID: ${{ secrets.MIRO_CLIENT_ID }}
          MIRO_REDIRECT_URI: https://claude.ai/api/mcp/auth_callback
          BASE_URL: https://miro-mcp-adr005.fly-agile.com
          MCP_SERVER_PORT: "3010"
        run: |
          REGISTRY_IMAGE="${{ steps.registry.outputs.endpoint }}/${{ env.PROJECT_NAME }}:latest"
          CONTAINER_ID=$(scw container container list region=${{ env.REGION }} -o json | jq -r ".[] | select(.name == \"${{ env.PROJECT_NAME }}\") | .id")

          if [ -z "$CONTAINER_ID" ] || [ "$CONTAINER_ID" = "null" ]; then
            echo "Creating new container..."
            CONTAINER_ID=$(scw container container create \
              name=${{ env.PROJECT_NAME }} \
              region=${{ env.REGION }} \
              namespace-id=${{ steps.registry.outputs.namespace_id }} \
              registry-image=${REGISTRY_IMAGE} \
              port=${MCP_SERVER_PORT} \
              min-scale=1 \
              max-scale=1 \
              cpu-limit=250 \
              memory-limit=256 \
              environment-variables.MIRO_CLIENT_ID="${MIRO_CLIENT_ID}" \
              environment-variables.MIRO_REDIRECT_URI="${MIRO_REDIRECT_URI}" \
              environment-variables.BASE_URL="${BASE_URL}" \
              environment-variables.MCP_SERVER_PORT="${MCP_SERVER_PORT}" \
              environment-variables.LOG_FORMAT="json" \
              environment-variables.RUST_LOG="info" \
              -o json | jq -r '.id')
          else
            echo "Updating existing container (ID: ${CONTAINER_ID})..."
            scw container container update ${CONTAINER_ID} \
              region=${{ env.REGION }} \
              registry-image=${REGISTRY_IMAGE} \
              environment-variables.MIRO_CLIENT_ID="${MIRO_CLIENT_ID}" \
              environment-variables.MIRO_REDIRECT_URI="${MIRO_REDIRECT_URI}" \
              environment-variables.BASE_URL="${BASE_URL}" \
              environment-variables.MCP_SERVER_PORT="${MCP_SERVER_PORT}" \
              environment-variables.LOG_FORMAT="json" \
              environment-variables.RUST_LOG="info"
          fi

          echo "Deploying container..."
          scw container container deploy ${CONTAINER_ID} region=${{ env.REGION }} --wait

      - name: Validate deployment
        run: |
          # Get container info
          CONTAINER_INFO=$(scw container container list region=${{ env.REGION }} -o json | jq -r ".[] | select(.name == \"${{ env.PROJECT_NAME }}\")")
          CONTAINER_URL=$(echo "$CONTAINER_INFO" | jq -r '.domain_name')
          CONTAINER_STATUS=$(echo "$CONTAINER_INFO" | jq -r '.status')

          echo "Container Status: $CONTAINER_STATUS"
          echo "Container URL: https://$CONTAINER_URL"

          # Wait for container to be ready
          MAX_ATTEMPTS=24
          SLEEP_INTERVAL=5

          for i in $(seq 1 $MAX_ATTEMPTS); do
            CURRENT_STATUS=$(scw container container list region=${{ env.REGION }} -o json | jq -r ".[] | select(.name == \"${{ env.PROJECT_NAME }}\") | .status")
            echo "Attempt $i/$MAX_ATTEMPTS - Status: $CURRENT_STATUS"

            if [ "$CURRENT_STATUS" == "ready" ]; then
              echo "✓ Container is ready"
              break
            elif [ "$CURRENT_STATUS" == "error" ]; then
              echo "✗ Container failed to start"
              CONTAINER_ID=$(echo "$CONTAINER_INFO" | jq -r '.id')
              scw container container get region=${{ env.REGION }} container-id=$CONTAINER_ID -o json | jq '.error_message'
              exit 1
            fi

            if [ $i -lt $MAX_ATTEMPTS ]; then
              sleep $SLEEP_INTERVAL
            else
              echo "✗ Timeout waiting for container to be ready"
              exit 1
            fi
          done

          # Test health endpoint
          HEALTH_ENDPOINT="https://${CONTAINER_URL}/health"
          echo "Testing health endpoint: $HEALTH_ENDPOINT"

          if curl -f -s "$HEALTH_ENDPOINT" > /dev/null 2>&1; then
            echo "✓ Health check passed"
            curl -s "$HEALTH_ENDPOINT"
          else
            echo "✗ Health check failed"
            exit 1
          fi

          # Test metadata endpoint (Resource Server)
          METADATA_ENDPOINT="https://${CONTAINER_URL}/.well-known/oauth-protected-resource"
          echo "Testing metadata endpoint: $METADATA_ENDPOINT"

          if curl -f -s "$METADATA_ENDPOINT" > /dev/null 2>&1; then
            echo "✓ Metadata check passed"
            curl -s "$METADATA_ENDPOINT" | jq '.'
          else
            echo "✗ Metadata check failed"
            exit 1
          fi

      - name: Deployment summary
        if: always()
        run: |
          CONTAINER_INFO=$(scw container container list region=${{ env.REGION }} -o json | jq -r ".[] | select(.name == \"${{ env.PROJECT_NAME }}\")")
          CONTAINER_URL=$(echo "$CONTAINER_INFO" | jq -r '.domain_name')
          CONTAINER_STATUS=$(echo "$CONTAINER_INFO" | jq -r '.status')

          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Container:** ${{ env.PROJECT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $CONTAINER_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${CONTAINER_URL}" >> $GITHUB_STEP_SUMMARY
          echo "**Health:** https://${CONTAINER_URL}/health" >> $GITHUB_STEP_SUMMARY
          echo "**OAuth Metadata:** https://${CONTAINER_URL}/.well-known/oauth-protected-resource" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "**Result:** ✓ Deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Result:** ✗ Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
